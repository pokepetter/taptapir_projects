<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <!-- <link rel="manifest" href="/manifest.json"> -->

    <!-- <title>snootboop.js</title> -->
    <link rel="stylesheet" href="../taptapir.css">
</head>

<body>
    <div id="game">
        <div id="loading_text">
        loading...<br><br><br><br><br><br><br>
        powered by taptapir
        </div>
    </div>

</body>

<script src="../taptapir.js"></script>


<script type='text/pokescript'>

set_orientation('horizontal')   // orientation
ASSETS_FOLDER = 'assets/'


symbols = ['☀️','🌙','🌟','🪐','🌠']
sample_names = ['UoIowaPiano_n24.wav','UoIowaPiano_n36.wav','UoIowaPiano_n48.wav','UoIowaPiano_n60.wav','UoIowaPiano_n72.wav']
for e in sample_names:
    var audio = new Audio(e)


bg_color = 'rgb(49 72 60)'
bg_color = 'black'
set_window_color(bg_color)
set_background_color('black')
on_color = '#85B112'

note_view_parent = Entity(xy=[-.75,-.25], color='black', origin=[0,-.5], scale=.075, visible_self=False)
notes = Array_2d(16, 8)
for y in range(8):
    for x in range(16):
        let e = Entity(parent=note_view_parent, origin=[-.5,-.5], xy=[x,y], on=False, scale=.95, roundness=.1, color='#111')
        notes[x][y] = e
        if x%4 == 0:
            e.color = '#222'
        e.original_color = e.color
        e.on_click = def():
            e.on = not e.on
            if e.on:
                e.color = on_color
            else:
                e.color = e.original_color

# sidebar for playing notes
side_notes = [Entity(parent=note_view_parent, origin=[-.5,-.5], xy=[-1.15,y], color='#333', roundness=.25) for y in range(8)]

scale_pattern = [1,2,2,1,2,1]
note_offset = 24

def set_note_offset(value):
    note_offset = value

    for i, e in enumerate(side_notes):
        print(e)
        e.text = `${note_offset + i}`
        e.on_click = def():
            play_note(note_offset + i)

set_note_offset(note_offset)


move_up = Entity(parent=note_view_parent, origin=[-.5,-.5], xy=[-1.2,8], color='#222', roundness=.25, text='^')
move_up.on_click = def():
    set_note_offset(note_offset+1)

move_down = Entity(parent=note_view_parent, origin=[-.5,-.5], xy=[-1.2,-1], color='#222', roundness=.25, text='v')
move_down.on_click = def():
    set_note_offset(note_offset-1)

# top toolbar
Entity(parent=note_view_parent, origin=[-.5,-.5], xy=[0,8.1], color='#333', roundness=.25, scale_x=1.9, text='copy')
Entity(parent=note_view_parent, origin=[-.5,-.5], xy=[2,8.1], color='#333', roundness=.25, scale_x=1.9, text='paste')
# set speed
speed = 1
speed_multipliers = [.25, .5, 1, 2, 4, 8]
for i in range(6):
    let e = Entity(parent=note_view_parent, origin=[-.5,-.5], xy=[i+4,8.1], color='#333', roundness=.25, scale_x=.95, text='a')
    e.text = `${speed_multipliers[i]}`
    e.on_click = def():
        speed = speed_multipliers[i]



limiter = Entity(
    scale_x=.05, scale_y=.075,
    xy=[note_view_parent.x+(note_view_parent.scale_x*16), note_view_parent.y-note_view_parent.scale_y-.01], origin=[0,-.5],
    min_x=note_view_parent.x+note_view_parent.scale_x, max_x=note_view_parent.x+note_view_parent.scale_x*16,
    color='#333', draggable=True, lock_y=True, snap_x=note_view_parent.scale_x, roundness=.5, text='∞')
limiter.shadower = Entity(parent=note_view_parent, scale=1, color='black', alpha=.75, origin=[-.5,-.5], scale=[0,8])

max_x = 16
limiter.drop = def():
    # limiter.world_parent = note_view_parent
    max_x = int((limiter.x - note_view_parent.x) / note_view_parent.scale_x)
    print(max_x)
    limiter.shadower.x = max_x-.05
    limiter.shadower.scale_x = 16-max_x

    if playing:
        play()
# limiter.while_dragging = def():
#     print(limiter.x)
    # limiter.x =

def convert_y_to_note(y):
    y = round(y*40)
    org_y = y
    octave = round(y/7)
    x = y - octave * 7
    print('x:', x)
    # org_y = y - (y/)
    # y += [2,1,2,2,2,1,2][x]
    y += 12
    print(org_y, '-->', 'octave:', octave, y)
    return y




current_time = 0
play_button = Button(text='play', color='orange', scale=1/7, y=-.025, shadow=true, xy=[.6,-.35])
playing = False

def play():
    playing = True
    stop_all_invokes()
    for x in range(max_x):
        for y in range(8):
            if notes[x][y].color == on_color:
                invoke(def anon():
                    play_note(note_offset + y)
                , delay=x*1/4 / speed)



play_button.on_click = play

def play_note(n):
    print('play note', n)
    octave = floor(n / 12)
    print('octave:', octave)
    var audio = new Audio(sample_names[octave])
    audio.volume = .5
    audio.mozPreservesPitch = false
    audio.preservesPitch = false
    audio.playbackRate = 2 ** ((n - (0 + 12*octave)) / 12)
    audio.play()


</script>
<script src="../pokescript_compiler.js"></script>
</html>
