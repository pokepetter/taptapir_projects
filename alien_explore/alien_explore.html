<html><title>Alien: Explore</title>
<head><meta charset="UTF-8"></head><body>
<script src="../taptapir/taptapir.js"></script>
<script type='text/sunsnake'>

# set_scale(.8)
set_background_color('#111111')
set_window_color('#3d529c')

DEFAULT_FONT = 'monospace'

class CurrencyHandler(Entity):
    def __init__(self, currencies={'🪙':0, }):
        super().__init__(color=color.red, visible_self=False)
        self.ui_parent = Entity(parent=camera.ui, position=[.5-.05,(.5*aspect_ratio)-.05], visible_self=False)
        self.currency_icons = dict()
        self.currencies = currencies
        self.prev_amounts = {}
        for name, obj in self.currencies:
            self.prev_amounts[name] = obj.amount

        self.data = {}
        for name, obj in self.currencies:
            self.data[name] = obj.amount
        return self.data

    get currencies():
        return self._currencies
    set currencies(value):
        self._currencies = value
        self.ui_parent.destroy_children()
        i = 0
        for name, obj in value:
            print(name, obj)
            if not obj.amount:
                obj.amount = 0
            if not 'unlocked' in obj:
                obj.unlocked = True

            let currency_icon = Button(parent=self.ui_parent, scale=.075, y=-(i*.08), roundness=.5, texture=obj.icon, text_size=2.5, shadow=True, enabled=obj.unlocked)
            currency_icon.original_scale = currency_icon.scale
            currency_icon.counter = Button(parent=currency_icon, padding=[.2,.1], origin=[.5,0], scale=[2,.9], position=[-.2,-.1,1], roundness=.5, text=obj.amount+' ', text_origin=[.5,0], text_size=2, text_color='#3e3e3e')
            currency_icon.counter.fit_to_text()
            self.currency_icons[name] = currency_icon
            i += 1

    # def unlock(self, name):
    #     self.currency_icons[name].enabled = True


    def update(self):
        for name, amount in self.data:
            if amount != self.prev_amounts[name]:
                if not self.currency_icons[name].enabled:
                    self.currency_icons[name].enabled = True

                self.currency_icons[name].counter.text = amount
                let difference = amount - self.prev_amounts[name]
                let icon = self.currencies[name].icon
                let number = Entity(parent=camera.ui, scale=.1, text=`+${difference}${icon}`, position=[mouse.x, mouse.y+.1], z=-10, roundness=.25, alpha=1)
                number.fit_to_text(1)
                number.padding=.05
                number.animate('y', number.y+.2, .3)
                after .3:
                    destroy(number)
                # self.currency_icons[name].scale = .1
                # self.currency_icons[name].animate('scale', self.currency_icons[name].original_scale, .1)
                self.currency_icons[name].counter.text_size = 2.5
                self.currency_icons[name].counter.animate('text_size', 2, .1)
                print(name, self.prev_amounts[name], '-->', amount)
                self.prev_amounts[name] = amount




# credits = dict(icon='🪙', amount=100)
# keys = dict(icon='🔑', amount=2)
# triangles = dict(icon='🔺', unlocked=False)
currs = {
    # 'credits' : dict(icon='https://game-icons.net/icons/ffffff/000000/1x1/delapouite/credits-currency.svg', amount=100),
    'energy' : dict(icon='https://game-icons.net/icons/ffffff/000000/1x1/sbed/battery-pack-alt.svg', amount=5),
    'crew' : dict(icon='https://game-icons.net/icons/ffffff/000000/1x1/lorc/space-suit.svg', amount=5),
    'triangles' : dict(icon='https://game-icons.net/icons/ffffff/000000/1x1/lorc/moebius-triangle.svg', unlocked=False),
}
currency = CurrencyHandler(currs)
# currency.triangles += 1
# currency.currencies = dict(keys=keys, start=stars)

# region tutorial
engine_room_scene = Scene(color=color.azure)

energy_button = Button(scale=.2, text='+1 energy')
energy_button.on_click = def():
    energy_bar.value += 1
    if energy_bar.value >= energy_bar.max and not power_up_button.enabled:
        power_up_button.enabled = True
        Entity(parent=power_up_button, texture='sparkle_impact.gif', scale=2)

energy_button.prev_trigger_time = time
energy_button.update = def _():
    if mouse.hovered_entity == energy_button and mouse.left and time-energy_button.prev_trigger_time > .1:
        energy_button.on_click()
        energy_button.prev_trigger_time = time

power_up_button = Button(y=-.3, color=color.azure, text=' power up', padding=.25, shadow=True, text_color=color.white, enabled=False, on_click=def():goto_scene(main_scene)).fit_to_text()

energy_bar = HealthBar(y=.3, bar_color=color.azure, text_color=color.white, max=20)
energy_bar.value = 0


# region main scene
main_scene = Scene(color='#111111')
# Entity(parent=main_scene, texture='main_screen', scale=[1,2], alpha=.2)
Entity(parent=main_scene, texture='map_3x3', scale=[1,2], alpha=.2)


class MissionButton(Button):
    def __init__(self, kwargs):
        super().__init__(roundness=.5, text='asteroid', text_size=1)
        for key, value in kwargs.items():
            this[key] = value
            # print('---', key, value)
        self.mission = kwargs.mission
        self.position = kwargs.position
        self.progress_bar = HealthBar(parent=this, y=1, max_value=100, scale=[1.3,.1], text_color=color.clear, text_size=1, bar_color=color.lime, enabled=False)
        self.progress_bar.value = 0
        self.reward_panel = Entity(parent=this, scale=[1.5,1.5], color=color.black, alpha=.9, y=.75, text='Success!', text_origin=[0,.5], text_color=color.lime, roundness=.1, padding=.1, text_size=2, shadow=True, enabled=False)
        self.reward_panel.description = Entity(parent=self.reward_panel, scale=[1,.4], y=.125, text='survivors: 10\niron: 2\ngold: 1', text_size=1.75, color=color.clear, text_color=color.light_gray)
        self.reward_panel.claim_button = Button(parent=self.reward_panel, text='Claim', color=color.azure, scale=[1,.4], y=-.3, text_color=color.white)
        self.reward_panel.claim_button.on_click = def():
            print('claim reward')
            print(self.reward_panel)
            self.reward_panel.enabled = False
            self.mission.in_progress = False
            for key, value in self.mission.reward:
                # if not key in currency.currencies:
                #     print('error: no currency', key)
                #     continue
                currency[key] += value


    # def reward_setter(self, value):
    #     self._reward = value
    #     # self.reward_panel.description.text =


    def update(self):
        if self.mission.in_progress:
            self.progress_bar.value += self.mission.rate + (held_keys['f']*10)
            if self.progress_bar.value >= self.progress_bar.max_value:
                self.mission.in_progress = False
                self.reward_panel.enabled = True
                self.progress_bar.enabled = False



mission_panel = Entity(scale=[.6,.3], color=color.black, alpha=.9, roundness=.05, z=-2, enabled=False, on_click=def():return)
mission_panel.title = Entity(parent=mission_panel, scale=[.95,.25], color='#123123', text='Asteroid', roundness=.1, text_origin=[0,0], text_color=color.white, y=.5)
mission_panel.description = Entity(parent=mission_panel, text='Success rate: 50%\nReward:10\nRequirements:', text_color=color.white, origin=[0,.5], y=.25, scale=[.9,.7], text_size=2.5, text_origin=[-.5,.5], color=color.clear)
mission_panel.start_mission_button = Button(parent=mission_panel, scale=[.8,.2], text='Start', color=color.orange, text_color=color.white, padding=[.2,.05], y=-.5, roundness=2, shadow=True).fit_to_text()
mission_panel.start_mission_button.cost_label = Button(parent=mission_panel.start_mission_button, origin=[-.5,-.5], x=-.25, text='?', text_origin=[-.5,0], text_size=1.5, color='#5d5d5dff', text_color='#c5c5c5', scale=[.5,.5], y=.5, roundness=.5, padding=[.05,.025])
# button.reward_label = Button(parent=button, text='?', text_origin=[.5,0], text_size=1.5, color='#5d5d5dff',text_color='#c5c5c5', scale=[.9,.5], x=.5, y=-.45, roundness=.5, padding=[.5,0])


mission_panel.bg = Entity(parent=mission_panel, scale=10, z=1, visible_self=False, on_click=def():mission_panel.enabled=False)
# mission_panel.enabled = False
def show_mission_info(mb):
    if mb.mission.in_progress:
        return
    mission_panel.title.text = mb.mission.title
    mission_panel.description.text = '???'
    mission_panel.x = clamp(mb.x, -.2, .2)
    mission_panel.y = mb.y + .2
    mission_panel.appear(.2)
    cost_text = ''
    for curr, amount in mb.mission.cost:
        if amount > 0:
            cost_text += `${amount}${curr} `
    if cost_text:
        cost_text = 'cost: ' + cost_text
    mission_panel.start_mission_button.cost_label.text = cost_text
    mission_panel.start_mission_button.cost_label.fit_to_text()


    # region start mission
    mission_panel.start_mission_button.on_click = def():
        can_afford = True
        for key, value in mb.mission.cost:
            if currency[key] - value < 0:
                can_afford = False
                break

        if not can_afford:
            print('cant afford')
            return

        mission_panel.enabled = False
        for key, value in mb.mission.cost:
            currency[key] -= value

        mb.progress_bar.value = 0
        mb.progress_bar.enabled = True
        mb.mission.in_progress = True
        print('start mission:', mb.mission)


missions = [
    dict(title='Asteroid', position=[-.2,.4], rate=.1, cost={crew=1, energy=10}, reward={credits=20, iron=1}, texture='https://img.freepik.com/premium-vector/asteroid-cartoon-icon-space-element-meteorite-sign_53562-23237.jpg'),
    dict(title='Asteroid2', position=[.2,.2], rate=.05, cost={energy=20}, reward={credits=35, iron=1}, texture='https://cdn-icons-png.flaticon.com/512/8146/8146602.png'),
    dict(title='Asteroid2', position=[.2,.2], rate=.05, cost={energy=20}, reward={credits=35, iron=1}, texture='https://cdn-icons-png.flaticon.com/512/8146/8146602.png'),
    dict(title='Asteroid2', position=[.2,.2], rate=.05, cost={energy=20}, reward={credits=35, iron=1}, texture='https://cdn-icons-png.flaticon.com/512/8146/8146602.png'),
    dict(title='Asteroid2', position=[.2,.2], rate=.05, cost={energy=20}, reward={credits=35, iron=1}, texture='https://cdn-icons-png.flaticon.com/512/8146/8146602.png'),
    dict(title='Asteroid2', position=[.2,.2], rate=.05, cost={energy=20}, reward={credits=35, iron=1}, texture='https://cdn-icons-png.flaticon.com/512/8146/8146602.png'),
    dict(title='Asteroid2', position=[.2,.2], rate=.05, cost={energy=20}, reward={credits=35, iron=1}, texture='https://cdn-icons-png.flaticon.com/512/8146/8146602.png'),
    dict(title='Asteroid2', position=[.2,.2], rate=.05, cost={energy=20}, reward={credits=35, iron=1}, texture='https://cdn-icons-png.flaticon.com/512/8146/8146602.png'),
    dict(title='Asteroid2', position=[.2,.2], rate=.05, cost={energy=20}, reward={credits=35, iron=1}, texture='https://cdn-icons-png.flaticon.com/512/8146/8146602.png'),
]
planet_parent = Entity(visible_self=False)
for i, m in missions:
    let mission_button = MissionButton(parent=planet_parent, mission=m, position=m.position, texture=m.texture, text=`${i}`, text_color=color.white, text_size=2, text_origin=[-.5,.5])
    mission_button.on_click = def():
        show_mission_info(mission_button)

grid_layout(planet_parent.children, dict(spacing=[1.5,1.5], offset=[-.25,-.2], max_x=3, y_direction=-1))

class Variable:
    def __init__(self, start_value):
        print('init variable to:', start_value)
        self.value = start_value

    get value():
        return self._value
    set value(value):
        print(self._value, '-->', value)
        if self._value != value:
            print('set value to:', value, self.on_value_changed)
            if self.on_value_changed:
                self.on_value_changed()
        self._value = value

# region survey button and planet unlocking
survey_button = Button(text='survey', y=.755, scale=[.25,.15], cost=0)
NUM_PLANETS_UNLOCKED = Variable(0)
NUM_PLANETS_UNLOCKED.on_value_changed = def():
    print('unlock planets')
    for e in planet_parent.children:
        e.locked = True
    for i in range(NUM_PLANETS_UNLOCKED):
        planet_parent.children[i].locked = False

survey_button.on_click = def():
    print(NUM_PLANETS_UNLOCKED.value)
    if NUM_PLANETS_UNLOCKED.value < 8:
        NUM_PLANETS_UNLOCKED.value += 1
        save_system_save('num_planets_unlocked', NUM_PLANETS_UNLOCKED.value)
NUM_PLANETS_UNLOCKED.value = save_system_load('num_planets_unlocked', 1)

research_scene = Scene()
ref = Entity(parent=research_scene, texture='research', scale=[1,2], alpha=.2)
ref.scale_x *= .9
ref.scale_y *= .9

title = Entity(y=.5*aspect_ratio, origin=[0,.5], scale=[1,.2], color='#3e363e', text='Research', text_origin=[0,0], text_size=5, text_color='#b8b8b8')

sunsnake.define(ResearchNode(, Button(scale=.15, roundness=.5, color='#897a7a', shadow=True, text='*', )
reseach_node = ResearchNode(position=[0,0])


# region bottom panel
bottom_panel = Entity(parent=scene, origin=[0,-.5], scale_y=.3, position=window.bottom)
button_group = Entity(parent=bottom_panel, scale=[.8,.9], y=.5, color=color.gray)
button_data = [
    dict(name='Engine\nRoom', target_scene=engine_room_scene),
    dict(name='Explore', target_scene=main_scene),
    dict(name='Research', target_scene=research_scene),
]

for i, data in button_data:
    b = Button(parent=button_group, text=data.name, scale=[.33,1], text_color=color.white, color=color.azure, x=(i/3)-.5+(.33/2))
    b.on_click = def():
        goto_scene(data.target_scene, fade_in_duration=.01, fade_out_duration=.1)

# levels_parent = Entity(parent=scene, scale=[.7,.1], color=color.gray, position=[0,-.525], visible_self=False)
# for i in range(7):
#     Button(parent=levels_parent, scale=[1/7,1], roundness=.25, color=color.red, text=`${i}`, text_size=2, x=-.5+(i*1/7)+(1/7/2))


goto_scene(main_scene, False) # set start scene

# b = Button(scale=.2, text='+2🪙', on_click=def():currency.credits += 2)
# b = Button(scale=.2, text='+1🔺', y=-.3, on_click=def():currency.triangles += 1)
# currency.gain('keys', 10)
# currency.gold += 10
# currencies = dict(
#     gold = dict(icon='🪙', amount=100),
#     keys = dict(icon='🔑', amount=0),
#     stars = dict(icon='⭐'),
#     # '💎','🪵','🪨','🫐','🍉','🥝']
# )
cheat_inputs = Entity(visible_self=False)
cheat_inputs.input = def input(key):
    if key == '1':
        currency.energy += 1
    if key == '2':
        currency.crew += 1
    if key == '3':
        currency.triangles += 1


# set_scale(.25)
mouse.click_animation = 'impact_effect.gif'
def input(key):
    if key == 'space': # cheats
        for c in scene_handler.state.children:
            c.enabled = True

</script><script src="../taptapir/sunsnake_compiler.js"></script>
<script type='text/sunsnake'>
